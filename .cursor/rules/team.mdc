---
description:
globs:
alwaysApply: true
---

# Weather Flick Admin Backend Team Rules

ë‹¹ì‹ ì€ Weather Flick ê´€ë¦¬ì ë°±ì—”ë“œ ê°œë°œì˜ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. FastAPI, Python, PostgreSQL, ê·¸ë¦¬ê³  ê´€ë¦¬ì ì‹œìŠ¤í…œ ê°œë°œì— ëŠ¥ìˆ™í•©ë‹ˆë‹¤.

## ğŸ¯ í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸

### ì—­í•  ë° ì±…ì„
- **ê´€ë¦¬ì API ì„œë²„**: FastAPI ê¸°ë°˜ ê´€ë¦¬ì ì „ìš© API ì„œë¹„ìŠ¤ (í¬íŠ¸: 8001)
- **ì‹œìŠ¤í…œ ê´€ë¦¬**: ì‚¬ìš©ì ê´€ë¦¬, ì½˜í…ì¸  ê´€ë¦¬, ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§
- **ê¶Œí•œ ê´€ë¦¬**: ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (RBAC) - ìŠˆí¼ê´€ë¦¬ì, ì¼ë°˜ê´€ë¦¬ì
- **ë°ì´í„° ê´€ë¦¬**: ê´€ê´‘ì§€ ì •ë³´, ë‚ ì”¨ ë°ì´í„°, ì‚¬ìš©ì ê´€ë¦¬
- **ëª¨ë‹ˆí„°ë§**: ì‹œìŠ¤í…œ ìƒíƒœ, ë¡œê·¸ ê´€ë¦¬, í†µê³„ ëŒ€ì‹œë³´ë“œ

### ê¸°ìˆ  ìŠ¤íƒ
- **Framework**: FastAPI 0.111.0
- **Language**: Python 3.11+
- **Database**: PostgreSQL + SQLAlchemy + Alembic
- **Validation**: Pydantic 2.7.1
- **Code Quality**: Ruff + Black + MyPy + pre-commit hooks

## ğŸ“ í•„ìˆ˜ í”„ë¡œì íŠ¸ êµ¬ì¡° (ì„œë¹„ìŠ¤ í”„ë¡œì íŠ¸ êµ¬ì¡° í†µì¼)

```
app/
â”œâ”€â”€ routers/           # API ì—”ë“œí¬ì¸íŠ¸ (ê´€ë¦¬ì íŠ¹í™”)
â”‚   â”œâ”€â”€ auth.py        # ê´€ë¦¬ì ì¸ì¦ ë° ê¶Œí•œ ê´€ë¦¬
â”‚   â”œâ”€â”€ users.py       # ì‚¬ìš©ì ê´€ë¦¬ (ê´€ë¦¬ììš©)
â”‚   â”œâ”€â”€ destinations.py # ì—¬í–‰ì§€ ê´€ë¦¬
â”‚   â”œâ”€â”€ weather.py     # ë‚ ì”¨ ë°ì´í„° ê´€ë¦¬
â”‚   â”œâ”€â”€ system.py      # ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ë° ê´€ë¦¬
â”‚   â”œâ”€â”€ dashboard.py   # ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
â”‚   â””â”€â”€ logs.py        # ë¡œê·¸ ë° í™œë™ ë‚´ì—­
â”œâ”€â”€ services/          # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â”œâ”€â”€ user_service.py      # ì‚¬ìš©ì ê´€ë¦¬ ì„œë¹„ìŠ¤
â”‚   â”œâ”€â”€ auth_service.py      # ê´€ë¦¬ì ì¸ì¦ ì„œë¹„ìŠ¤
â”‚   â”œâ”€â”€ dashboard_service.py # ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì„œë¹„ìŠ¤
â”‚   â”œâ”€â”€ system_service.py    # ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤
â”‚   â””â”€â”€ log_service.py       # ë¡œê·¸ ê´€ë¦¬ ì„œë¹„ìŠ¤
â”œâ”€â”€ schemas/           # Pydantic ìŠ¤í‚¤ë§ˆ
â”‚   â”œâ”€â”€ auth.py        # ì¸ì¦ ê´€ë ¨ ìŠ¤í‚¤ë§ˆ
â”‚   â”œâ”€â”€ users.py       # ì‚¬ìš©ì ê´€ë¦¬ ìŠ¤í‚¤ë§ˆ
â”‚   â”œâ”€â”€ dashboard.py   # ëŒ€ì‹œë³´ë“œ ìŠ¤í‚¤ë§ˆ
â”‚   â””â”€â”€ system.py      # ì‹œìŠ¤í…œ ê´€ë ¨ ìŠ¤í‚¤ë§ˆ
â”œâ”€â”€ models.py          # SQLAlchemy ëª¨ë¸ë“¤
â”œâ”€â”€ database.py        # DB ì—°ê²° ë° ì„¸ì…˜ ê´€ë¦¬
â”œâ”€â”€ auth.py           # ì¸ì¦ ë° ê¶Œí•œ ê´€ë¦¬
â”œâ”€â”€ config.py          # ì„¤ì • ë° í™˜ê²½ë³€ìˆ˜
â””â”€â”€ utils/            # ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    â”œâ”€â”€ security.py    # ë³´ì•ˆ ê´€ë ¨ ìœ í‹¸ë¦¬í‹°
    â””â”€â”€ logging.py     # ë¡œê¹… ìœ í‹¸ë¦¬í‹°
```

## ğŸ› ï¸ í•µì‹¬ ê°œë°œ ì›ì¹™

### 1. ê´€ë¦¬ì ê¶Œí•œ ê¸°ë°˜ ê°œë°œ
- **ìŠˆí¼ê´€ë¦¬ì**: ëª¨ë“  ì‹œìŠ¤í…œ ì ‘ê·¼ ê¶Œí•œ
- **ì¼ë°˜ê´€ë¦¬ì**: ì œí•œëœ ê´€ë¦¬ ê¶Œí•œ
- **ê¶Œí•œ ê²€ì¦**: ëª¨ë“  APIì— í•„ìˆ˜ ê¶Œí•œ í™•ì¸

### 2. ê´€ë¦¬ì ë¼ìš°í„° íŒ¨í„´ (í•„ìˆ˜ ì¤€ìˆ˜)

```python
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from typing import List, Optional

from app.database import get_db
from app.auth import require_admin, require_super_admin
from app.services.user_service import UserService
from app.models import User

router = APIRouter(prefix="/admin/users", tags=["admin-users"])

@router.get("/", response_model=List[UserResponse])
async def get_all_users(
    skip: int = 0,
    limit: int = 100,
    search: Optional[str] = None,
    db: Session = Depends(get_db),
    admin_user: User = Depends(require_admin),  # ê´€ë¦¬ì ê¶Œí•œ í•„ìˆ˜
) -> List[UserResponse]:
    """
    ëª¨ë“  ì‚¬ìš©ì ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤. (ê´€ë¦¬ì ì „ìš©)

    Args:
        skip: ê±´ë„ˆë›¸ ë ˆì½”ë“œ ìˆ˜
        limit: ë°˜í™˜í•  ë ˆì½”ë“œ ìˆ˜ (ìµœëŒ€ 100)
        search: ê²€ìƒ‰ í‚¤ì›Œë“œ (ì´ë©”ì¼, ë‹‰ë„¤ì„)
        db: ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜
        admin_user: í˜„ì¬ ê´€ë¦¬ì ì‚¬ìš©ì

    Returns:
        List[UserResponse]: ì‚¬ìš©ì ëª©ë¡

    Raises:
        HTTPException: ê¶Œí•œ ì—†ìŒ ë˜ëŠ” ì¡°íšŒ ì‹¤íŒ¨
    """
    try:
        service = UserService(db)
        users = await service.get_users_for_admin(
            skip=skip,
            limit=min(limit, 100),  # ìµœëŒ€ 100ê°œ ì œí•œ
            search=search
        )

        # ê´€ë¦¬ì í™œë™ ë¡œê·¸
        await log_admin_activity(
            admin_user.id,
            "USER_LIST_VIEW",
            f"ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ (ê²€ìƒ‰: {search}, ê²°ê³¼: {len(users)}ê°œ)"
        )

        return users
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {str(e)}"
        )

@router.delete("/{user_id}")
async def delete_user(
    user_id: int,
    db: Session = Depends(get_db),
    admin_user: User = Depends(require_super_admin),  # ìŠˆí¼ê´€ë¦¬ìë§Œ
) -> dict:
    """
    ì‚¬ìš©ìë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. (ìŠˆí¼ê´€ë¦¬ì ì „ìš©)
    """
    # Early Returnìœ¼ë¡œ ì…ë ¥ ê²€ì¦
    if user_id <= 0:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="ìœ íš¨í•˜ì§€ ì•Šì€ ì‚¬ìš©ì IDì…ë‹ˆë‹¤"
        )

    # ë³¸ì¸ ì‚­ì œ ë°©ì§€
    if user_id == admin_user.id:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="ë³¸ì¸ ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        )

    try:
        service = UserService(db)
        result = await service.delete_user(user_id)

        # ì¤‘ìš”í•œ ê´€ë¦¬ì í™œë™ ë¡œê·¸
        await log_admin_activity(
            admin_user.id,
            "USER_DELETE",
            f"ì‚¬ìš©ì ì‚­ì œ (ID: {user_id})",
            severity="HIGH"
        )

        return {"message": "ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤", "user_id": user_id}
    except ValueError as e:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=str(e)
        )
```

### 3. ê¶Œí•œ ì˜ì¡´ì„± íŒ¨í„´ (í•„ìˆ˜)

```python
# auth.py
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from sqlalchemy.orm import Session
from jose import JWTError, jwt
from typing import Optional

from app.database import get_db
from app.config import get_settings
from app.models import User

security = HTTPBearer()
settings = get_settings()

async def get_current_admin_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    db: Session = Depends(get_db)
) -> User:
    """í˜„ì¬ ê´€ë¦¬ì ì‚¬ìš©ì ì¡°íšŒ"""
    try:
        payload = jwt.decode(
            credentials.credentials,
            settings.secret_key,
            algorithms=[settings.algorithm]
        )
        user_id: int = payload.get("sub")
        if user_id is None:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤"
            )
    except JWTError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="í† í° ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"
        )

    user = db.get(User, user_id)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        )

    if not user.is_active:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤"
        )

    return user

async def require_admin(
    current_user: User = Depends(get_current_admin_user)
) -> User:
    """ì¼ë°˜ ê´€ë¦¬ì ì´ìƒ ê¶Œí•œ í•„ìš”"""
    if current_user.role not in ["admin", "super_admin"]:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤"
        )
    return current_user

async def require_super_admin(
    current_user: User = Depends(get_current_admin_user)
) -> User:
    """ìŠˆí¼ê´€ë¦¬ì ê¶Œí•œ í•„ìš”"""
    if current_user.role != "super_admin":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="ìŠˆí¼ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤"
        )
    return current_user
```

### 4. ê´€ë¦¬ì ì„œë¹„ìŠ¤ íŒ¨í„´ (í•„ìˆ˜)

```python
# services/user_service.py
from sqlalchemy.orm import Session
from sqlalchemy import select, and_, or_, func
from typing import List, Optional, Dict, Any
from datetime import datetime, timedelta
import logging

from app.models import User, TravelPlan
from app.schemas.users import UserResponse, UserStatsResponse

logger = logging.getLogger(__name__)

class UserService:
    """ì‚¬ìš©ì ê´€ë¦¬ ì„œë¹„ìŠ¤ (ê´€ë¦¬ììš©)"""

    def __init__(self, db: Session):
        self.db = db

    async def get_users_for_admin(
        self,
        skip: int = 0,
        limit: int = 100,
        search: Optional[str] = None,
        role_filter: Optional[str] = None,
        is_active: Optional[bool] = None
    ) -> List[UserResponse]:
        """
        ê´€ë¦¬ììš© ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ (ìƒì„¸ ì •ë³´ í¬í•¨)

        Args:
            skip: ê±´ë„ˆë›¸ ë ˆì½”ë“œ ìˆ˜
            limit: ë°˜í™˜í•  ë ˆì½”ë“œ ìˆ˜
            search: ê²€ìƒ‰ í‚¤ì›Œë“œ
            role_filter: ì—­í•  í•„í„°
            is_active: í™œì„±í™” ìƒíƒœ í•„í„°

        Returns:
            List[UserResponse]: ì‚¬ìš©ì ëª©ë¡ (ê´€ë¦¬ììš© ìƒì„¸ ì •ë³´)
        """
        try:
            # ì…ë ¥ ê²€ì¦ (Early Return)
            if skip < 0:
                raise ValueError("skipì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤")

            if limit <= 0 or limit > 100:
                raise ValueError("limitëŠ” 1-100 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤")

            # ê¸°ë³¸ ì¿¼ë¦¬ êµ¬ì„±
            query = select(User)

            # ê²€ìƒ‰ ì¡°ê±´ ì¶”ê°€
            if search:
                search_term = f"%{search}%"
                query = query.where(
                    or_(
                        User.email.ilike(search_term),
                        User.nickname.ilike(search_term)
                    )
                )

            # í•„í„° ì¡°ê±´ ì¶”ê°€
            if role_filter:
                query = query.where(User.role == role_filter)

            if is_active is not None:
                query = query.where(User.is_active == is_active)

            # ì •ë ¬ ë° í˜ì´ì§•
            query = query.order_by(User.created_at.desc()).offset(skip).limit(limit)

            users = self.db.execute(query).scalars().all()

            # ì¶”ê°€ í†µê³„ ì •ë³´ í¬í•¨í•œ ì‘ë‹µ ìƒì„±
            user_responses = []
            for user in users:
                # ê° ì‚¬ìš©ìì˜ ì—¬í–‰ ê³„íš ìˆ˜ ì¡°íšŒ
                plan_count = self.db.execute(
                    select(func.count(TravelPlan.id)).where(TravelPlan.user_id == user.id)
                ).scalar()

                user_responses.append(UserResponse(
                    id=user.id,
                    email=user.email,
                    nickname=user.nickname,
                    role=user.role,
                    is_active=user.is_active,
                    is_verified=user.is_verified,
                    travel_plan_count=plan_count,
                    last_login=user.last_login,
                    created_at=user.created_at,
                    updated_at=user.updated_at
                ))

            logger.info(f"ê´€ë¦¬ììš© ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì™„ë£Œ: {len(user_responses)}ê°œ")
            return user_responses

        except ValueError:
            raise
        except Exception as e:
            logger.error(f"ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {e}")
            raise

    async def get_user_statistics(self) -> UserStatsResponse:
        """ì‚¬ìš©ì í†µê³„ ì •ë³´ ì¡°íšŒ"""
        try:
            # ì „ì²´ ì‚¬ìš©ì ìˆ˜
            total_users = self.db.execute(select(func.count(User.id))).scalar()

            # í™œì„± ì‚¬ìš©ì ìˆ˜
            active_users = self.db.execute(
                select(func.count(User.id)).where(User.is_active == True)
            ).scalar()

            # ìµœê·¼ 30ì¼ ì‹ ê·œ ê°€ì…ì ìˆ˜
            thirty_days_ago = datetime.now() - timedelta(days=30)
            new_users_30d = self.db.execute(
                select(func.count(User.id)).where(User.created_at >= thirty_days_ago)
            ).scalar()

            # ì¸ì¦ëœ ì‚¬ìš©ì ìˆ˜
            verified_users = self.db.execute(
                select(func.count(User.id)).where(User.is_verified == True)
            ).scalar()

            return UserStatsResponse(
                total_users=total_users,
                active_users=active_users,
                new_users_30d=new_users_30d,
                verified_users=verified_users,
                verification_rate=round((verified_users / total_users * 100), 2) if total_users > 0 else 0
            )

        except Exception as e:
            logger.error(f"ì‚¬ìš©ì í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: {e}")
            raise

    async def delete_user(self, user_id: int) -> bool:
        """ì‚¬ìš©ì ì‚­ì œ (ê´€ë¦¬ì ì „ìš©)"""
        try:
            # ì‚¬ìš©ì ì¡´ì¬ í™•ì¸
            user = self.db.get(User, user_id)
            if not user:
                raise ValueError(f"ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {user_id}")

            # ìŠˆí¼ê´€ë¦¬ì ì‚­ì œ ë°©ì§€
            if user.role == "super_admin":
                raise ValueError("ìŠˆí¼ê´€ë¦¬ìëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤")

            # ê´€ë ¨ ë°ì´í„° í™•ì¸ (í•„ìš”ì‹œ cascade ì‚­ì œ ë˜ëŠ” ì˜¤ë¥˜ ì²˜ë¦¬)
            plan_count = self.db.execute(
                select(func.count(TravelPlan.id)).where(TravelPlan.user_id == user_id)
            ).scalar()

            if plan_count > 0:
                logger.warning(f"ì‚¬ìš©ì {user_id} ì‚­ì œ ì‹œ ì—¬í–‰ê³„íš {plan_count}ê°œë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤")

            # ì‚¬ìš©ì ì‚­ì œ ì‹¤í–‰
            self.db.delete(user)
            self.db.commit()

            logger.info(f"ì‚¬ìš©ì ì‚­ì œ ì™„ë£Œ: {user_id} (ì´ë©”ì¼: {user.email})")
            return True

        except ValueError:
            raise
        except Exception as e:
            self.db.rollback()
            logger.error(f"ì‚¬ìš©ì ì‚­ì œ ì‹¤íŒ¨: {e}, ì‚¬ìš©ì: {user_id}")
            raise
```

### 5. ê´€ë¦¬ì ìŠ¤í‚¤ë§ˆ íŒ¨í„´

```python
# schemas/users.py
from pydantic import BaseModel, Field, validator, ConfigDict
from typing import Optional, List
from datetime import datetime
from enum import Enum

class UserRoleEnum(str, Enum):
    USER = "user"
    ADMIN = "admin"
    SUPER_ADMIN = "super_admin"

class UserResponse(BaseModel):
    """ê´€ë¦¬ììš© ì‚¬ìš©ì ì‘ë‹µ ìŠ¤í‚¤ë§ˆ (ìƒì„¸ ì •ë³´ í¬í•¨)"""
    model_config = ConfigDict(from_attributes=True)

    id: int
    email: str
    nickname: str
    role: UserRoleEnum
    is_active: bool
    is_verified: bool

    # ê´€ë¦¬ììš© ì¶”ê°€ ì •ë³´
    travel_plan_count: int = Field(default=0, description="ìƒì„±í•œ ì—¬í–‰ê³„íš ìˆ˜")
    last_login: Optional[datetime] = Field(None, description="ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„")
    created_at: datetime
    updated_at: datetime

class UserStatsResponse(BaseModel):
    """ì‚¬ìš©ì í†µê³„ ì‘ë‹µ ìŠ¤í‚¤ë§ˆ"""
    total_users: int = Field(..., description="ì „ì²´ ì‚¬ìš©ì ìˆ˜")
    active_users: int = Field(..., description="í™œì„± ì‚¬ìš©ì ìˆ˜")
    new_users_30d: int = Field(..., description="ìµœê·¼ 30ì¼ ì‹ ê·œ ê°€ì…ì ìˆ˜")
    verified_users: int = Field(..., description="ì¸ì¦ëœ ì‚¬ìš©ì ìˆ˜")
    verification_rate: float = Field(..., description="ì¸ì¦ë¥  (%)")

class UserUpdateRequest(BaseModel):
    """ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • ìš”ì²­ ìŠ¤í‚¤ë§ˆ (ê´€ë¦¬ììš©)"""
    model_config = ConfigDict(str_strip_whitespace=True)

    nickname: Optional[str] = Field(None, min_length=2, max_length=50)
    role: Optional[UserRoleEnum] = None
    is_active: Optional[bool] = None
    is_verified: Optional[bool] = None

    @validator('nickname')
    def validate_nickname(cls, v):
        if v and not v.replace('_', '').replace('-', '').isalnum():
            raise ValueError('ë‹‰ë„¤ì„ì€ ì˜ë¬¸, ìˆ«ì, _, - ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤')
        return v
```

## ğŸš¨ ë³´ì•ˆ ë° ê¶Œí•œ ê´€ë¦¬ ê·œì¹™

### 1. ê´€ë¦¬ì ì¸ì¦ ê°•í™”

```python
# services/auth_service.py
from passlib.context import CryptContext
from jose import jwt, JWTError
from datetime import datetime, timedelta
import secrets
import logging

logger = logging.getLogger(__name__)
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

class AdminAuthService:
    """ê´€ë¦¬ì ì¸ì¦ ì„œë¹„ìŠ¤"""

    @staticmethod
    def create_admin_access_token(user_id: int, role: str, expires_delta: timedelta = None) -> str:
        """ê´€ë¦¬ììš© JWT í† í° ìƒì„± (ì¶”ê°€ í´ë ˆì„ í¬í•¨)"""
        if expires_delta:
            expire = datetime.utcnow() + expires_delta
        else:
            expire = datetime.utcnow() + timedelta(hours=8)  # ê´€ë¦¬ìëŠ” 8ì‹œê°„ ìœ íš¨

        to_encode = {
            "sub": str(user_id),
            "role": role,
            "exp": expire,
            "iat": datetime.utcnow(),
            "type": "admin_access",  # í† í° íƒ€ì… ëª…ì‹œ
            "jti": secrets.token_hex(16),  # JWT IDë¡œ í† í° ë¬´íš¨í™” ê°€ëŠ¥
        }

        encoded_jwt = jwt.encode(to_encode, settings.secret_key, algorithm=settings.algorithm)

        # í† í° ìƒì„± ë¡œê·¸
        logger.info(f"ê´€ë¦¬ì í† í° ìƒì„±: ì‚¬ìš©ì {user_id}, ì—­í•  {role}, ë§Œë£Œ {expire}")

        return encoded_jwt

    @staticmethod
    async def log_admin_activity(
        admin_id: int,
        action: str,
        description: str,
        target_resource: Optional[str] = None,
        severity: str = "NORMAL"
    ):
        """ê´€ë¦¬ì í™œë™ ë¡œê·¸ ê¸°ë¡"""
        log_entry = {
            "admin_id": admin_id,
            "action": action,
            "description": description,
            "target_resource": target_resource,
            "severity": severity,
            "timestamp": datetime.utcnow(),
            "ip_address": "127.0.0.1",  # ì‹¤ì œë¡œëŠ” requestì—ì„œ ê°€ì ¸ì˜¤ê¸°
        }

        # ë°ì´í„°ë² ì´ìŠ¤ì— ë¡œê·¸ ì €ì¥
        # await save_admin_log(log_entry)

        # ì¤‘ìš”í•œ í™œë™ì€ ë³„ë„ ì•Œë¦¼
        if severity in ["HIGH", "CRITICAL"]:
            logger.warning(f"ì¤‘ìš” ê´€ë¦¬ì í™œë™: {description} (ê´€ë¦¬ì: {admin_id})")
```

### 2. ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§

```python
# services/system_service.py
from sqlalchemy.orm import Session
from sqlalchemy import select, func, and_
from typing import List, Dict, Any
from datetime import datetime, timedelta
import psutil
import logging

logger = logging.getLogger(__name__)

class SystemLogService:
    """ì‹œìŠ¤í…œ ë¡œê·¸ ë° ëª¨ë‹ˆí„°ë§ ì„œë¹„ìŠ¤"""

    def __init__(self, db: Session):
        self.db = db

    async def get_system_health(self) -> Dict[str, Any]:
        """ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸"""
        try:
            # CPU ì‚¬ìš©ë¥ 
            cpu_percent = psutil.cpu_percent(interval=1)

            # ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ 
            memory = psutil.virtual_memory()
            memory_percent = memory.percent

            # ë””ìŠ¤í¬ ì‚¬ìš©ë¥ 
            disk = psutil.disk_usage('/')
            disk_percent = disk.percent

            # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
            try:
                self.db.execute(select(1))
                db_status = "healthy"
            except Exception as e:
                db_status = f"error: {str(e)}"
                logger.error(f"ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜: {e}")

            # ìµœê·¼ ì˜¤ë¥˜ ë¡œê·¸ ìˆ˜
            recent_errors = await self._count_recent_errors()

            health_status = {
                "timestamp": datetime.utcnow(),
                "cpu_percent": cpu_percent,
                "memory_percent": memory_percent,
                "disk_percent": disk_percent,
                "database_status": db_status,
                "recent_errors_24h": recent_errors,
                "overall_status": "healthy" if all([
                    cpu_percent < 80,
                    memory_percent < 80,
                    disk_percent < 80,
                    db_status == "healthy",
                    recent_errors < 100
                ]) else "warning"
            }

            return health_status

        except Exception as e:
            logger.error(f"ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: {e}")
            return {
                "timestamp": datetime.utcnow(),
                "overall_status": "error",
                "error": str(e)
            }

    async def _count_recent_errors(self) -> int:
        """ìµœê·¼ 24ì‹œê°„ ì˜¤ë¥˜ ë¡œê·¸ ìˆ˜ ì¡°íšŒ"""
        try:
            twenty_four_hours_ago = datetime.utcnow() - timedelta(hours=24)
            # ì‹¤ì œ ë¡œê·¸ í…Œì´ë¸”ì—ì„œ ì¡°íšŒí•˜ëŠ” ë¡œì§ êµ¬í˜„
            # í˜„ì¬ëŠ” ë”ë¯¸ ê°’ ë°˜í™˜
            return 0
        except Exception:
            return 0
```

## ğŸ”§ ì½”ë“œ í’ˆì§ˆ ë° í…ŒìŠ¤íŠ¸ ê·œì¹™

### 1. ê´€ë¦¬ì ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸

```python
# tests/test_admin_users.py
import pytest
from fastapi.testclient import TestClient
from unittest.mock import Mock, patch
from httpx import AsyncClient

from app.main import app
from app.models import User

class TestAdminUserManagement:
    """ê´€ë¦¬ì ì‚¬ìš©ì ê´€ë¦¬ í…ŒìŠ¤íŠ¸"""

    @pytest.fixture
    def admin_user(self):
        return User(
            id=1,
            email="admin@weatherflick.com",
            nickname="admin",
            role="admin",
            is_active=True
        )

    @pytest.fixture
    def super_admin_user(self):
        return User(
            id=2,
            email="superadmin@weatherflick.com",
            nickname="superadmin",
            role="super_admin",
            is_active=True
        )

    @pytest.fixture
    def admin_token(self, admin_user):
        return create_admin_access_token(admin_user.id, admin_user.role)

    @pytest.fixture
    def super_admin_token(self, super_admin_user):
        return create_admin_access_token(super_admin_user.id, super_admin_user.role)

    async def test_get_users_as_admin_success(self, admin_token):
        """ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì„±ê³µ"""
        async with AsyncClient(app=app, base_url="http://test") as ac:
            response = await ac.get(
                "/admin/users/",
                headers={"Authorization": f"Bearer {admin_token}"}
            )

        assert response.status_code == 200
        assert "users" in response.json() or isinstance(response.json(), list)

    async def test_get_users_without_admin_permission_fail(self):
        """ê´€ë¦¬ì ê¶Œí•œ ì—†ì´ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨"""
        async with AsyncClient(app=app, base_url="http://test") as ac:
            response = await ac.get("/admin/users/")

        assert response.status_code == 401

    async def test_delete_user_as_super_admin_success(self, super_admin_token):
        """ìŠˆí¼ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‚¬ìš©ì ì‚­ì œ ì„±ê³µ"""
        user_id = 999

        with patch('app.users.service.UserService.delete_user') as mock_delete:
            mock_delete.return_value = True

            async with AsyncClient(app=app, base_url="http://test") as ac:
                response = await ac.delete(
                    f"/admin/users/{user_id}",
                    headers={"Authorization": f"Bearer {super_admin_token}"}
                )

            assert response.status_code == 200
            mock_delete.assert_called_once_with(user_id)

    async def test_delete_user_as_regular_admin_fail(self, admin_token):
        """ì¼ë°˜ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‚¬ìš©ì ì‚­ì œ ì‹¤íŒ¨ (ìŠˆí¼ê´€ë¦¬ì ì „ìš©)"""
        user_id = 999

        async with AsyncClient(app=app, base_url="http://test") as ac:
            response = await ac.delete(
                f"/admin/users/{user_id}",
                headers={"Authorization": f"Bearer {admin_token}"}
            )

        assert response.status_code == 403
```

### 2. ê´€ë¦¬ì í™œë™ ë¡œê·¸ í…ŒìŠ¤íŠ¸

```python
# tests/test_admin_logging.py
import pytest
from unittest.mock import AsyncMock, patch

from app.auth.utils import AdminAuthService

class TestAdminLogging:
    """ê´€ë¦¬ì í™œë™ ë¡œê·¸ í…ŒìŠ¤íŠ¸"""

    @pytest.mark.asyncio
    async def test_log_admin_activity(self):
        """ê´€ë¦¬ì í™œë™ ë¡œê·¸ ê¸°ë¡ í…ŒìŠ¤íŠ¸"""
        admin_id = 1
        action = "USER_DELETE"
        description = "ì‚¬ìš©ì ì‚­ì œ (ID: 999)"

        with patch('app.auth.utils.save_admin_log') as mock_save:
            mock_save.return_value = True

            await AdminAuthService.log_admin_activity(
                admin_id=admin_id,
                action=action,
                description=description,
                severity="HIGH"
            )

            mock_save.assert_called_once()
            args = mock_save.call_args[0][0]
            assert args["admin_id"] == admin_id
            assert args["action"] == action
            assert args["severity"] == "HIGH"
```

## ğŸ“Š ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë°ì´í„° íŒ¨í„´

### 1. í†µê³„ ë°ì´í„° ì„œë¹„ìŠ¤

```python
# services/dashboard_service.py
from sqlalchemy.orm import Session
from sqlalchemy import select, func, and_
from typing import Dict, List, Any
from datetime import datetime, timedelta

class DashboardService:
    """ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë°ì´í„° ì„œë¹„ìŠ¤"""

    def __init__(self, db: Session):
        self.db = db

    async def get_dashboard_stats(self) -> Dict[str, Any]:
        """ëŒ€ì‹œë³´ë“œ ì¢…í•© í†µê³„"""
        try:
            # ì‹œê°„ ë²”ìœ„ ì„¤ì •
            now = datetime.utcnow()
            today = now.replace(hour=0, minute=0, second=0, microsecond=0)
            week_ago = today - timedelta(days=7)
            month_ago = today - timedelta(days=30)

            # ì‚¬ìš©ì í†µê³„
            user_stats = await self._get_user_statistics(today, week_ago, month_ago)

            # ì—¬í–‰ ê³„íš í†µê³„
            plan_stats = await self._get_travel_plan_statistics(today, week_ago, month_ago)

            # ì‹œìŠ¤í…œ í†µê³„
            system_stats = await self._get_system_statistics()

            return {
                "timestamp": now,
                "users": user_stats,
                "travel_plans": plan_stats,
                "system": system_stats
            }

        except Exception as e:
            logger.error(f"ëŒ€ì‹œë³´ë“œ í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: {e}")
            raise

    async def _get_user_statistics(self, today: datetime, week_ago: datetime, month_ago: datetime) -> Dict[str, Any]:
        """ì‚¬ìš©ì ê´€ë ¨ í†µê³„"""
        # ì „ì²´ ì‚¬ìš©ì ìˆ˜
        total_users = self.db.execute(select(func.count(User.id))).scalar()

        # ì˜¤ëŠ˜ ì‹ ê·œ ê°€ì…ì
        new_today = self.db.execute(
            select(func.count(User.id)).where(User.created_at >= today)
        ).scalar()

        # ì£¼ê°„ ì‹ ê·œ ê°€ì…ì
        new_week = self.db.execute(
            select(func.count(User.id)).where(User.created_at >= week_ago)
        ).scalar()

        # í™œì„± ì‚¬ìš©ì ìˆ˜
        active_users = self.db.execute(
            select(func.count(User.id)).where(User.is_active == True)
        ).scalar()

        return {
            "total": total_users,
            "new_today": new_today,
            "new_week": new_week,
            "active": active_users,
            "growth_rate": round((new_week / total_users * 100), 2) if total_users > 0 else 0
        }

    async def get_recent_activities(self, limit: int = 50) -> List[Dict[str, Any]]:
        """ìµœê·¼ ê´€ë¦¬ì í™œë™ ë‚´ì—­"""
        try:
            # ì‹¤ì œë¡œëŠ” admin_logs í…Œì´ë¸”ì—ì„œ ì¡°íšŒ
            # í˜„ì¬ëŠ” ë”ë¯¸ ë°ì´í„° ë°˜í™˜
            activities = [
                {
                    "id": 1,
                    "admin_email": "admin@weatherflick.com",
                    "action": "USER_UPDATE",
                    "description": "ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • (ID: 123)",
                    "timestamp": datetime.utcnow() - timedelta(minutes=30),
                    "severity": "NORMAL"
                }
            ]

            return activities

        except Exception as e:
            logger.error(f"ê´€ë¦¬ì í™œë™ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨: {e}")
            raise
```

## ğŸ”§ ê°œë°œ ì›Œí¬í”Œë¡œìš° (ê´€ë¦¬ì íŠ¹í™”)

### 1. ê´€ë¦¬ì ê¸°ëŠ¥ ê°œë°œ ì²´í¬ë¦¬ìŠ¤íŠ¸

```bash
# 1. ê¶Œí•œ ê²€ì¦ í™•ì¸
# - ëª¨ë“  ê´€ë¦¬ì APIì— ì ì ˆí•œ ê¶Œí•œ ì˜ì¡´ì„± ì ìš©
# - require_admin ë˜ëŠ” require_super_admin ì‚¬ìš©

# 2. í™œë™ ë¡œê·¸ ì¶”ê°€
# - ì¤‘ìš”í•œ ê´€ë¦¬ì í™œë™ì€ ë°˜ë“œì‹œ ë¡œê·¸ ê¸°ë¡
# - log_admin_activity í•¨ìˆ˜ ì‚¬ìš©

# 3. ì…ë ¥ ê²€ì¦ ê°•í™”
# - ê´€ë¦¬ì APIëŠ” ë” ì—„ê²©í•œ ì…ë ¥ ê²€ì¦ ì ìš©
# - Early Return íŒ¨í„´ìœ¼ë¡œ ë³´ì•ˆ ê°•í™”

# 4. ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 
# - ê´€ë¦¬ìì—ê²ŒëŠ” ìƒì„¸í•œ ì˜¤ë¥˜ ì •ë³´ ì œê³µ
# - ë¯¼ê°í•œ ì •ë³´ëŠ” ë¡œê·¸ì—ë§Œ ê¸°ë¡

# 5. í…ŒìŠ¤íŠ¸ ì‘ì„±
# - ê¶Œí•œë³„ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‘ì„±
# - ë³´ì•ˆ í…ŒìŠ¤íŠ¸ í•„ìˆ˜ í¬í•¨
```

### 2. ë°°í¬ ì „ ë³´ì•ˆ ê²€ì¦

```bash
# ë³´ì•ˆ ê²€ì¦ ëª…ë ¹ì–´
ruff check --fix .                    # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
black .                               # ì½”ë“œ í¬ë§·íŒ…
mypy app/                            # íƒ€ì… ê²€ì‚¬
pytest tests/test_admin_*.py -v      # ê´€ë¦¬ì ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
bandit -r app/                       # ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
pre-commit run --all-files           # ì „ì²´ í’ˆì§ˆ ê²€ì‚¬

# í™˜ê²½ë³€ìˆ˜ ê²€ì¦
python -c "from app.config import get_settings; get_settings()"
```

ì´ ê·œì¹™ë“¤ì„ ì¤€ìˆ˜í•˜ì—¬ ì•ˆì „í•˜ê³  íš¨ìœ¨ì ì¸ Weather Flick ê´€ë¦¬ì ë°±ì—”ë“œë¥¼ ê°œë°œí•˜ì„¸ìš”. íŠ¹íˆ ê¶Œí•œ ê´€ë¦¬ì™€ ë³´ì•ˆ ë¡œê¹…ì— ê°ë³„í•œ ì£¼ì˜ë¥¼ ê¸°ìš¸ì´ì„¸ìš”.
